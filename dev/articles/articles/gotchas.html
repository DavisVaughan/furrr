<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Common gotchas • furrr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Common gotchas">
<meta property="og:description" content="furrr">
<meta property="og:image" content="/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">furrr</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.1.0.9002</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/carrier.html">Alternative to automatic globals detection</a>
    </li>
    <li>
      <a href="../../articles/articles/chunking.html">Chunking input</a>
    </li>
    <li>
      <a href="../../articles/articles/gotchas.html">Common gotchas</a>
    </li>
    <li>
      <a href="../../articles/articles/remote-connections.html">Remote connections</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DavisVaughan/furrr/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="gotchas_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Common gotchas</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DavisVaughan/furrr/blob/master/vignettes/articles/gotchas.Rmd"><code>vignettes/articles/gotchas.Rmd</code></a></small>
      <div class="hidden name"><code>gotchas.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">furrr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">purrr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)</pre></body></html></div>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This article lists a few common gotchas when working with furrr.</p>
</div>
<div id="non-standard-evaluation-of-arguments" class="section level2">
<h2 class="hasAnchor">
<a href="#non-standard-evaluation-of-arguments" class="anchor"></a>Non-standard evaluation of arguments</h2>
<p>One difference with purrr is that furrr has to evaluate the arguments passed through <code>...</code> in functions such as <code><a href="../../reference/future_map.html">future_map()</a></code>. This has to happen before they can be serialized and shipped off to the worker sessions. It is guaranteed that these arguments are evaluated only once, but this prevents some “lazy” behavior that is possible with purrr. For example:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">filter_for_dogs</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>, <span class="no">col</span>) {
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">data</span>, {{ <span class="no">col</span> }} <span class="kw">==</span> <span class="st">"dog"</span>)
}

<span class="no">df1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(
  <span class="kw">pets</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"dog"</span>, <span class="st">"cat"</span>),
  <span class="kw">names</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Floofy"</span>, <span class="st">"Buttercup"</span>)
)

<span class="no">df2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(
  <span class="kw">pets</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"horse"</span>, <span class="st">"dog"</span>, <span class="st">"mouse"</span>),
  <span class="kw">names</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Stalone"</span>, <span class="st">"Fido"</span>, <span class="st">"Cheesy"</span>)
)

<span class="no">dfs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">df1</span>, <span class="no">df2</span>)</pre></body></html></div>
<p><code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> delays evaluation as long as possible, and <code>pets</code> is evaluated in a context where the data frame exists, so it can detect that <code>pets</code> is a column in the data frame.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="no">dfs</span>, <span class="no">filter_for_dogs</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">pets</span>)
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; # A tibble: 1 x 2</span>
<span class="co">#&gt;   pets  names </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; </span>
<span class="co">#&gt; 1 dog   Floofy</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; # A tibble: 1 x 2</span>
<span class="co">#&gt;   pets  names</span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 dog   Fido</span></pre></body></html></div>
<p><code><a href="../../reference/future_map.html">future_map()</a></code> has to evaluate each argument early, so <code>pets</code> is evaluated in a context where the data frame doesn’t exist, so we get an error.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="../../reference/future_map.html">future_map</a></span>(<span class="no">dfs</span>, <span class="no">filter_for_dogs</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">pets</span>)
<span class="co">#&gt; Error in get_globals_and_packages(options$globals, options$packages, map_fn, : object 'pets' not found</span></pre></body></html></div>
<p>One alternative is to pass the column through as a character string, and to use the <code>.data</code> pronoun to retrieve the column.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">filter_for_dogs2</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>, <span class="no">col</span>) {
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">data</span>, <span class="no">.data</span><span class="kw">[[</span><span class="no">col</span>]] <span class="kw">==</span> <span class="st">"dog"</span>)
}</pre></body></html></div>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="../../reference/future_map.html">future_map</a></span>(<span class="no">dfs</span>, <span class="no">filter_for_dogs2</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"pets"</span>)
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; # A tibble: 1 x 2</span>
<span class="co">#&gt;   pets  names </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; </span>
<span class="co">#&gt; 1 dog   Floofy</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; # A tibble: 1 x 2</span>
<span class="co">#&gt;   pets  names</span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 dog   Fido</span></pre></body></html></div>
</div>
<div id="argument-evaluation" class="section level2">
<h2 class="hasAnchor">
<a href="#argument-evaluation" class="anchor"></a>Argument evaluation</h2>
<p>In both purrr and furrr, there is a difference between passing arguments through <code>...</code> and specifying arguments in the anonymous function directly. Arguments passed through <code>...</code> are evaluated just once. If you want the argument to be evaluated at each iteration, you’ll need to put it inside the anonymous function. For example:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="fl">3</span>)

<span class="no">plus</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">y</span>) <span class="no">x</span> + <span class="no">y</span></pre></body></html></div>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">123</span>)

<span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span>(<span class="no">x</span>, <span class="no">plus</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">1</span>))
<span class="co">#&gt; [1] 0.2875775 0.2875775 0.2875775</span>

<span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span>(<span class="no">x</span>, ~ <span class="fu">plus</span>(<span class="no">.x</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">1</span>)))
<span class="co">#&gt; [1] 0.7883051 0.4089769 0.8830174</span></pre></body></html></div>
<p>This is the case with both furrr and purrr, but is a common question.</p>
<p>Note that in the furrr case, when you evaluate the argument in the anonymous function it will be evaluated on the worker itself. This means that to control the reproducibility, you should pass an <code>options</code> argument with a specified seed.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu">plan</span>(<span class="no">multisession</span>, <span class="kw">workers</span> <span class="kw">=</span> <span class="fl">2</span>)

<span class="no">options</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/furrr_options.html">furrr_options</a></span>(<span class="kw">seed</span> <span class="kw">=</span> <span class="fl">123</span>)

<span class="fu"><a href="../../reference/future_map.html">future_map_dbl</a></span>(<span class="no">x</span>, <span class="no">plus</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">1</span>))
<span class="co">#&gt; [1] 0.9404673 0.9404673 0.9404673</span>

<span class="fu"><a href="../../reference/future_map.html">future_map_dbl</a></span>(<span class="no">x</span>, ~ <span class="fu">plus</span>(<span class="no">.x</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">1</span>)), <span class="kw">.options</span> <span class="kw">=</span> <span class="no">options</span>)
<span class="co">#&gt; [1] 0.1552317 0.4877356 0.5330014</span>

<span class="fu">plan</span>(<span class="no">sequential</span>)</pre></body></html></div>
</div>
<div id="grouped-data-frames" class="section level2">
<h2 class="hasAnchor">
<a href="#grouped-data-frames" class="anchor"></a>Grouped data frames</h2>
<p>A common source of frustration is swapping a <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> for a <code><a href="../../reference/future_map.html">future_map()</a></code> and realizing that your computation is proceeding massively slower than it was with <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>. One possible reason for this is that you have called <code><a href="../../reference/future_map.html">future_map()</a></code> on a column of a grouped data frame. For example it is possible for the following data frame to arise naturally if you have nested a grouped data frame.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">123</span>)

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(
  <span class="kw">g</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">100</span>,
  <span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span>(<span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">10</span>), <span class="kw">simplify</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
)

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">df</span>, <span class="no">g</span>)

<span class="no">df</span>
<span class="co">#&gt; # A tibble: 100 x 2</span>
<span class="co">#&gt; # Groups:   g [100]</span>
<span class="co">#&gt;        g x         </span>
<span class="co">#&gt;    &lt;int&gt; &lt;list&gt;    </span>
<span class="co">#&gt;  1     1 &lt;dbl [10]&gt;</span>
<span class="co">#&gt;  2     2 &lt;dbl [10]&gt;</span>
<span class="co">#&gt;  3     3 &lt;dbl [10]&gt;</span>
<span class="co">#&gt;  4     4 &lt;dbl [10]&gt;</span>
<span class="co">#&gt;  5     5 &lt;dbl [10]&gt;</span>
<span class="co">#&gt;  6     6 &lt;dbl [10]&gt;</span>
<span class="co">#&gt;  7     7 &lt;dbl [10]&gt;</span>
<span class="co">#&gt;  8     8 &lt;dbl [10]&gt;</span>
<span class="co">#&gt;  9     9 &lt;dbl [10]&gt;</span>
<span class="co">#&gt; 10    10 &lt;dbl [10]&gt;</span>
<span class="co">#&gt; # … with 90 more rows</span></pre></body></html></div>
<p>If you’d like to map over this and perform some computation on each element of <code>x</code>, you might try and use <code><a href="../../reference/future_map.html">future_map_dbl()</a></code>, but you’ll be surprised about how slow it can be.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu">plan</span>(<span class="no">multisession</span>, <span class="kw">workers</span> <span class="kw">=</span> <span class="fl">2</span>)

<span class="no">t1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()

<span class="no">df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="../../reference/future_map.html">future_map_dbl</a></span>(<span class="no">x</span>, <span class="no">mean</span>))
<span class="co">#&gt; # A tibble: 100 x 3</span>
<span class="co">#&gt; # Groups:   g [100]</span>
<span class="co">#&gt;        g x              y</span>
<span class="co">#&gt;    &lt;int&gt; &lt;list&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt;  1     1 &lt;dbl [10]&gt; 0.578</span>
<span class="co">#&gt;  2     2 &lt;dbl [10]&gt; 0.523</span>
<span class="co">#&gt;  3     3 &lt;dbl [10]&gt; 0.616</span>
<span class="co">#&gt;  4     4 &lt;dbl [10]&gt; 0.538</span>
<span class="co">#&gt;  5     5 &lt;dbl [10]&gt; 0.345</span>
<span class="co">#&gt;  6     6 &lt;dbl [10]&gt; 0.433</span>
<span class="co">#&gt;  7     7 &lt;dbl [10]&gt; 0.554</span>
<span class="co">#&gt;  8     8 &lt;dbl [10]&gt; 0.425</span>
<span class="co">#&gt;  9     9 &lt;dbl [10]&gt; 0.559</span>
<span class="co">#&gt; 10    10 &lt;dbl [10]&gt; 0.415</span>
<span class="co">#&gt; # … with 90 more rows</span>

<span class="no">t2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()

<span class="fu">plan</span>(<span class="no">sequential</span>)

<span class="no">t2</span> - <span class="no">t1</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   2.120   0.100   2.729</span></pre></body></html></div>
<p>The issue here is that the grouped nature of the data frame prevents furrr from doing what it is good at - sharding the <code>x</code> column into equally sized groups and sending them off to the workers to process them in parallel.</p>
<p>Instead, because this data frame is grouped, and each group corresponds to 1 row of the data frame, dplyr hands <code><a href="../../reference/future_map.html">future_map_dbl()</a></code> 1 element of <code>x</code> at a time to operate on. So <code><a href="../../reference/future_map.html">future_map_dbl()</a></code> is actually being called 100 times here!</p>
<p>The easy solution is to just ungroup the data frame before calling <code><a href="../../reference/future_map.html">future_map_dbl()</a></code>.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu">plan</span>(<span class="no">multisession</span>, <span class="kw">workers</span> <span class="kw">=</span> <span class="fl">2</span>)

<span class="no">t1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()

<span class="no">df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="../../reference/future_map.html">future_map_dbl</a></span>(<span class="no">x</span>, <span class="no">mean</span>))
<span class="co">#&gt; # A tibble: 100 x 3</span>
<span class="co">#&gt;        g x              y</span>
<span class="co">#&gt;    &lt;int&gt; &lt;list&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt;  1     1 &lt;dbl [10]&gt; 0.578</span>
<span class="co">#&gt;  2     2 &lt;dbl [10]&gt; 0.523</span>
<span class="co">#&gt;  3     3 &lt;dbl [10]&gt; 0.616</span>
<span class="co">#&gt;  4     4 &lt;dbl [10]&gt; 0.538</span>
<span class="co">#&gt;  5     5 &lt;dbl [10]&gt; 0.345</span>
<span class="co">#&gt;  6     6 &lt;dbl [10]&gt; 0.433</span>
<span class="co">#&gt;  7     7 &lt;dbl [10]&gt; 0.554</span>
<span class="co">#&gt;  8     8 &lt;dbl [10]&gt; 0.425</span>
<span class="co">#&gt;  9     9 &lt;dbl [10]&gt; 0.559</span>
<span class="co">#&gt; 10    10 &lt;dbl [10]&gt; 0.415</span>
<span class="co">#&gt; # … with 90 more rows</span>

<span class="no">t2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()

<span class="fu">plan</span>(<span class="no">sequential</span>)

<span class="no">t2</span> - <span class="no">t1</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.067   0.002   0.205</span></pre></body></html></div>
</div>
<div id="graphics-devices" class="section level2">
<h2 class="hasAnchor">
<a href="#graphics-devices" class="anchor"></a>Graphics devices</h2>
<p>If you use a multicore plan, you shouldn’t try to generate and save plots with any graphics devices, which includes using ggplot2. This can cause an X11 fatal error because it can’t be safely run in a forked environment, which can crash your R session. Instead, you should use <code>plan(multisession)</code> to avoid these issues. See <a href="https://github.com/DavisVaughan/furrr/issues/27">this issue</a> for more details.</p>
</div>
<div id="package-development" class="section level2">
<h2 class="hasAnchor">
<a href="#package-development" class="anchor"></a>Package development</h2>
<p>When developing a package that imports and calls functions from furrr, you’ll likely be using <code>devtools::load_all()</code> as part of your development process. It is likely that unless you install your package, you might run into issues where functions internal to your package aren’t being exported to your workers (see <a href="https://github.com/DavisVaughan/furrr/issues/95">issue #95</a>).</p>
<p>Specifically, if you do the following, you will probably have issues:</p>
<ol style="list-style-type: decimal">
<li><p>Your package has not yet been <em>installed</em> on your machine, or you have an old version installed.</p></li>
<li><p>You call <code>devtools::load_all()</code>.</p></li>
<li><p>You set up a multisession or multicore strategy for furrr.</p></li>
<li><p>You call <code><a href="../../reference/future_map.html">future_map()</a></code> or any other furrr function from inside your package, and <code>.f</code> contains a function specific to your package.</p></li>
</ol>
<p>In this example, the underlying globals package will likely think that the function you called from <code>.f</code> is part of a package that is installed on your machine, so it won’t try and export it to the workers. Instead, it will just try and load up that package on the worker to get access to the function. Since the package hasn’t been installed on your machine yet (<code>load_all()</code> just <em>mocks</em> a fake installation) the workers will fail to attach it.</p>
<p>The solution is just to install your package with <code>devtools::install()</code> or using the RStudio Build pane, and then to restart R. Make sure that you re-install whenever you make any additional changes to the package.</p>
</div>
<div id="function-environments-and-large-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#function-environments-and-large-objects" class="anchor"></a>Function environments and large objects</h2>
<p>When <code><a href="../../reference/future_map.html">future_map()</a></code> and friends are called from within another function, you have to be extremely careful about the <code>.f</code> function that you pass through. If the function that <code><a href="../../reference/future_map.html">future_map()</a></code> is called from contains a large object, it is possible for that object to get captured by the function environment of <code>.f</code> and be exported to the worker, even if you never used it in the function itself.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">my_fast_fn</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
  <span class="fu"><a href="../../reference/future_map.html">future_map</a></span>(<span class="fl">1</span>:<span class="fl">5</span>, ~<span class="no">.x</span>)
}

<span class="no">my_slow_fn</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
  <span class="co"># Massive object - but we don't want it in `.f`</span>
  <span class="no">big</span> <span class="kw">&lt;-</span> <span class="fl">1</span>:<span class="fl">1e8</span> + <span class="fl">0L</span>

  <span class="fu"><a href="../../reference/future_map.html">future_map</a></span>(<span class="fl">1</span>:<span class="fl">5</span>, ~<span class="no">.x</span>)
}</pre></body></html></div>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="fu">plan</span>(<span class="no">multisession</span>, <span class="kw">workers</span> <span class="kw">=</span> <span class="fl">2</span>)

<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(
  <span class="fu">my_fast_fn</span>()
)
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.032   0.001   0.169</span>

<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(
  <span class="fu">my_slow_fn</span>()
)
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   3.386   0.635   5.757</span>

<span class="fu">plan</span>(<span class="no">sequential</span>)</pre></body></html></div>
<p>In the above example, <code>big</code> is captured in the function environment of the anonymous function <code>~.x</code> and is exported. Note that the problem isn’t that <code>big</code> is identified as a global by furrr. We can even prove that it is on the workers using <code><a href="https://rdrr.io/r/base/get.html">get()</a></code> to look for an object called <code>"big"</code> in the current and surrounding environments. I’ll use a smaller object here, but the concept is the same.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu">plan</span>(<span class="no">multisession</span>, <span class="kw">workers</span> <span class="kw">=</span> <span class="fl">2</span>)

<span class="no">my_slow_fn2</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
  <span class="no">big</span> <span class="kw">&lt;-</span> <span class="st">"can you find me?"</span>

  <span class="fu"><a href="../../reference/future_map.html">future_map</a></span>(<span class="fl">1</span>:<span class="fl">2</span>, ~<span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="st">"big"</span>))
}

<span class="fu">my_slow_fn2</span>()
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] "can you find me?"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] "can you find me?"</span>

<span class="fu">plan</span>(<span class="no">sequential</span>)</pre></body></html></div>
<p>One solution to this is to create <code>.f</code> somewhere where it won’t capture that massive object in its surrounding environment. For example:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">fn</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="no">x</span>
}

<span class="no">my_not_so_slow_fn</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
  <span class="no">big</span> <span class="kw">&lt;-</span> <span class="fl">1</span>:<span class="fl">1e8</span> + <span class="fl">0L</span>

  <span class="fu"><a href="../../reference/future_map.html">future_map</a></span>(<span class="fl">1</span>:<span class="fl">5</span>, <span class="no">fn</span>)
}

<span class="fu">plan</span>(<span class="no">multisession</span>, <span class="kw">workers</span> <span class="kw">=</span> <span class="fl">2</span>)

<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(
  <span class="fu">my_not_so_slow_fn</span>()
)
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.582   0.242   0.983</span>

<span class="fu">plan</span>(<span class="no">sequential</span>)</pre></body></html></div>
<p>Here lexical scoping is used to find <code>fn</code>, but you could also pass it in as an argument to <code>my_not_so_slow_fn()</code>. This works naturally in a package development environment, where <code>fn()</code> would just be a helper function in your package that you can call from anywhere else in the package without issue.</p>
<p>Again, we can prove that the object doesn’t make it onto the workers:</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu">plan</span>(<span class="no">multisession</span>, <span class="kw">workers</span> <span class="kw">=</span> <span class="fl">2</span>)

<span class="no">fn2</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="co"># does an object called `"big"` exist anywhere we can find it?</span>
  <span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span>(<span class="st">"big"</span>)
}

<span class="no">my_not_so_slow_fn2</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
  <span class="no">big</span> <span class="kw">&lt;-</span> <span class="st">"can you find me?"</span>

  <span class="fu"><a href="../../reference/future_map.html">future_map</a></span>(<span class="fl">1</span>:<span class="fl">2</span>, <span class="no">fn2</span>)
}

<span class="fu">my_not_so_slow_fn2</span>()
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] FALSE</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] FALSE</span>

<span class="fu">plan</span>(<span class="no">sequential</span>)</pre></body></html></div>
<p>Another alternative to help with this issue is to use the carrier package to <em>crate</em> the function. To learn more about this, see the article entitled <em>Alternative to automatic globals detection</em>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Davis Vaughan, Matt Dancho.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
